<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Introduction to Apptainer/Singularity: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [ ['$','$'], ['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav "><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="" src="assets/images/-logo.svg"><abbr class="icon" title="This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team." style="text-decoration: unset">
           
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#polishing-beta-stage" class="external-link alert-link" style="color: #383838">Beta
            <i aria-hidden="true" class="icon" data-feather="alert-circle" style="color: #001483; border-radius: 5px"></i>
          </a>
          <span class="visually-hidden">This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container ">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav " aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="" src="assets/images/-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Introduction to Apptainer/Singularity
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
      <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Introduction to Apptainer/Singularity
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"></ul>
</li>
      </ul>
</div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
<input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset>
</form>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Introduction to Apptainer/Singularity
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress ">
    <div class="progress-bar " role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
  <div id="sidebar-col" class="col-lg-4">
    <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle"><i class="search-icon" data-feather="x" role="img"></i></button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->
      
            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. Introduction</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-running-containers.html">2. Containers and Images</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-break.html">3. Coffee break!</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-building-containers.html">4. Building Containers</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-definition-files.html">5. Containers from definition files</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-break.html">6. Coffee break!</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="07-file-sharing.html">7. Sharing files between host and container</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="08-instances.html">8. Apptainer/Singularity instances</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="09-bonus-episode.html">9. Bonus Episode: Building and deploying an Apptainer container to Github Packages</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="aio.html">See all in one page</a>

            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">
            
            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-introduction"><p>Content from <a href="01-introduction.html">Introduction</a></p>
<hr>
<p> Last updated on 2023-08-14 | 
        
        <a href="https://github.com/mambelli/hsf-training-apptainer/edit/main/episodes/01-introduction.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“What issues motivated the creation of Apptainer/Singularity?”</li>
<li>“What are the differences between Docker, Apptainer and
Singularity?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Learn the design goals behind Apptainer/Singularity.”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<iframe width="427" height="251" src="https://www.youtube.com/embed/v5WbqtRbH6M?list=PLKZ9c4ONm-VkxWW98Gcn9H6WwykMiqtnF" title="Intro to Apptainer/Singularity #1 - Introduction" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe><div class="section level1">
<h1 id="working-with-containers">Working with containers<a class="anchor" aria-label="anchor" href="#working-with-containers"></a>
</h1>
<p>Containers are packages of software that encapsulates a system
environment. An OS-level virtualization is delivered in a container, and
any program running on it will use the contextualization isolated inside
the container. They have the advantage that you can build a container on
any system, your laptop for example, and then execute it anywhere as far
as the platform compatible with the container is available.</p>
<p>Concepts such as reproducibility, preservation, and distribution are
important in the HEP community, and the containers provide a solution
totally compatible with such concepts: * The version of some specific
software used to perform an analysis can be preserved in a container
with exactly the same environment used at that time. * A “legacy
software” with binaries only available for an outdated OS can be
executed inside a container. * All the necessary packages to process
data can be easily distributed in containers, independently of the
operating system available on the sites.</p>
<div id="what-about-virtual-machines" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="what-about-virtual-machines" class="callout-inner">
<h3 class="callout-title">What about virtual machines?<a class="anchor" aria-label="anchor" href="#what-about-virtual-machines"></a>
</h3>
<div class="callout-content">
<p>Virtual Machines (VMs) provide the same isolation and
reproducibility. However, they emulate the hardware, so they are
computationally heavier to run, require bigger files when distributed
and are less flexible than containers, that run only what you require to
be different.</p>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="why-apptainersingularity">Why Apptainer/Singularity?<a class="anchor" aria-label="anchor" href="#why-apptainersingularity"></a>
</h1>
<p>Many solutions are available to work with containers, for example <a href="https://www.docker.com/" class="external-link">Docker</a>, one of the most popular
platforms. However, the enterprise-based container frameworks were
motivated to provide <em>micro-services</em>, a solution that fits well
in the models of the industry, where system administrators with root
privilege install and run applications, each in its own container. This
is not so compatible with the workflow in the High-Performance Computing
(HPC) and High Throughput Computing (HTC), in which usually complex
applications run exhaustively using all the available resources and
without any special privilege.</p>
<p>Apptainer/Singularity is a container platform created for the HPC/HTC
use case. It allows to build and run containers with just a few steps in
most of the cases, and its design presents key concepts for the
scientific community: * Single-file based container images, facilitating
the distribution, archiving and sharing. * Ability to run, and in modern
systems also to be installed, without any root daemon or setuid
privileges. This makes it safer for large computer centers with shared
resources. * Preserves the permissions in the environment. The user
outside the container can be the same user inside. * Simple integration
with resource managers and distributed computing frameworks because it
runs as a regular application.</p>
<p><a href="https://apptainer.org/docs/user/" class="external-link">
<img src="https://apptainer.org/docs/user/main/_static/logo.png" alt="Apptainer/Singularity" width="220" class="figure"></a></p>
<div id="docker-and-apptainersingularity" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="docker-and-apptainersingularity" class="callout-inner">
<h3 class="callout-title">Docker and Apptainer/Singularity<a class="anchor" aria-label="anchor" href="#docker-and-apptainersingularity"></a>
</h3>
<div class="callout-content">
<p>As you will learn in this training module, Apptainer/Singularity <a href="https://apptainer.org/docs/user/main/docker_and_oci.html" class="external-link"><em>can</em>
be used with Docker images</a>. If you want to learn more about docker,
check out <a href="https://hsf-training.github.io/hsf-training-docker/index.html" class="external-link">our
docker training</a>.</p>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="apptainer-vs-singularity">Apptainer vs Singularity<a class="anchor" aria-label="anchor" href="#apptainer-vs-singularity"></a>
</h1>
<p>In these lessons you see the name <em>Apptainer</em> or
<em>Apptainer/Singularity</em>, and the command <code>apptainer</code>.
As stated in the <a href="https://apptainer.org/news/community-announcement-20211130/" class="external-link">move
and renaming announcement</a>, “Singularity IS Apptainer”. Currently
there are three products derived from the original Singularity project
from 2015: * <em>Singularity</em>: commercial software by <a href="https://sylabs.io/" class="external-link">Sylabs</a>. * <a href="https://sylabs.io/2022/06/singularityce-is-singularity/" class="external-link"><em>SingularityCE</em></a>:
open source Singularity supported by Sylabs. * <em>Apptainer</em>: open
source Singularity, recently renamed and hosted by the <a href="https://www.linuxfoundation.org/" class="external-link">Linux Foundation</a>. As of Fall
2022 all three Apptainer/Singularity versions are compatible and
practically the same, but have different roadmaps. There is hope that in
the future they will join forces, but this is not currently the case. To
understand how this came to be you can read the <a href="https://en.wikipedia.org/wiki/Singularity_%28software%29#History" class="external-link">Singularity
history on Wikipedia</a>.</p>
<p>We are following Apptainer, the most adopted variation in the
scientific community, so we are using the <code>apptainer</code>
command. If you are using Singularity or SingularityCE, just replace the
command <code>apptainer</code> with <code>singularity</code> and the
<code>APPTAINER_</code> and <code>APPTAINERENV_</code> variable prefixes
with <code>SINGULARITY_</code> and <code>SINGULARITYENV_</code>. But
since its previous version was named Singularity and it If you have
older scripts still using the <code>singularity</code> command they will
work also in Apptainer because it is providing the
<code>singularity</code> alias and <a href="https://apptainer.org/docs/user/main/singularity_compatibility.html" class="external-link">full
compatibility with the previous Singularity environment</a>.</p>
</div>
<div class="section level1">
<h1 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a>
</h1>
<p>The <a href="https://apptainer.org/docs/" class="external-link">official Apptainer
documentation</a> is available online. Contains basic and advanced usage
of Apptainer/Singularity beyond the scope of this training document.
Take a look and read the nice <a href="https://apptainer.org/docs/user/main/introduction.html" class="external-link">introduction</a>,
explaining the motivation behind the creation of
Apptainer/Singularity.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“Apptainer/Singularity is a container platform designed by and for
scientists.”</li>
<li>“Single-file based container images facilitates the
distribution.”</li>
<li>“Secure. User inside the container = user outside.”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div></section><section id="aio-02-running-containers"><p>Content from <a href="02-running-containers.html">Containers and Images</a></p>
<hr>
<p> Last updated on 2023-08-14 | 
        
        <a href="https://github.com/mambelli/hsf-training-apptainer/edit/main/episodes/02-running-containers.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How to pull Apptainer images from the libraries?”</li>
<li>“How to run commands inside the containers?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Learn to search and pull images from the Sylabs Singularity library
and Docker Hub.”</li>
<li>“Interact with the containers using the command-line
interface.”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<iframe width="427" height="251" src="https://www.youtube.com/embed/puSbnD415Ow?list=PLKZ9c4ONm-VkxWW98Gcn9H6WwykMiqtnF" title="Intro to Apptainer/Singularity #2 - Containers and Images" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe><div class="section level1">
<h1 id="the-apptainer-command-line-interface">The Apptainer Command Line Interface<a class="anchor" aria-label="anchor" href="#the-apptainer-command-line-interface"></a>
</h1>
<p>Apptainer provides a command-line interface (CLI) to interact with
the containers. You can search, build or run containers in a single
line.</p>
<p>You can check the version of the Apptainer or Singularity command you
are using with the <code>--version</code> option:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">singularity</span> <span class="at">--version</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This works for both Singularity and Apptainer, which installs a link named `singularity` to maintain compatibility.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># In the future you may need to use `apptainer --version`</span></span></code></pre>
</div>
<p>For this training we recommend Apptainer &gt;= 1.0 or Singularity
&gt;= 3.5. Older versions may not have some of the features or behave
differently. If you need to install or upgrade Apptainer/Singularity
please refer to the <a href="index.html#setup">Setup section</a>. When asking
for support please remember to include the version of Apptainer or
Singularity being used, as in the output of the above commands.</p>
<p>You can check the available options and subcommands using
<code>--help</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> <span class="at">--help</span></span></code></pre>
</div>
</div>
<div class="section level1">
<h1 id="downloading-images">Downloading Images<a class="anchor" aria-label="anchor" href="#downloading-images"></a>
</h1>
<p>Apptainer/Singularity can store, search and retrieve images in
registries. Images built by other users can be accessible using the CLI,
can be pulled down, and become containers at runtime.</p>
<p>Sylabs, the developers of one Singularity flavor, hosts a public
image registry, the <a href="https://cloud.sylabs.io/library" class="external-link">Singularity Container Library</a>
where many user built images are available.</p>
<p>The Linux Foundation flavor, Apptainer, does not point by default to
the Sylab registry as previous versions did. You can change that running
these commands (documented <a href="https://apptainer.org/docs/user/main/endpoint.html#restoring-pre-apptainer-library-behavior" class="external-link">here</a>):</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> remote add <span class="at">--no-login</span> SylabsCloud cloud.sycloud.io</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO:    Remote "SylabsCloud" added.</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> remote use SylabsCloud</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO:    Remote "SylabsCloud" now in use.</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> remote list</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Cloud Services Endpoints
========================

NAME           URI                  ACTIVE  GLOBAL  EXCLUSIVE
DefaultRemote  cloud.apptainer.org  NO      YES     NO
SylabsCloud    cloud.sycloud.io     YES     NO      NO
...</code></pre>
</div>
<p>Once you have setup a working registry you can use search and pull.
The command <code>search</code> lists containers of interest and shows
information about groups and collections. For example:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this command can take around a minute to complete</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> search centos7</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>No users found for 'centos7'

Found 1 collections for 'centos7'
        library://shahzebmsiddiqui/easybuild-centos7

Found 15 containers for 'centos7'
        library://gmk/default/centos7-devel
                Tags: latest
...</code></pre>
</div>
<p>Downloading an image from the Container Library is pretty
straightforward:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> pull library://gmk/default/centos7-devel</span></code></pre>
</div>
<p>and the image is stored locally as a <code>.sif</code> file
(<code>centos7-devel_latest.sif</code>, in this case).</p>
<div id="docker-images" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="docker-images" class="callout-inner">
<h3 class="callout-title">Docker Images<a class="anchor" aria-label="anchor" href="#docker-images"></a>
</h3>
<div class="callout-content">
<p>Fortunately, Apptainer is also compatible with Docker images. There
are many more registries with Docker images. <a href="https://hub.docker.com/" class="external-link">Docker Hub</a> is one of the largest
libraries available, and any image hosted on the hub can be easily
downloaded with the <code>docker://</code> URL as reference:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> pull docker://centos:centos7</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="running-containers">Running Containers<a class="anchor" aria-label="anchor" href="#running-containers"></a>
</h1>
<p>There are several ways to interact with images and start containers.
Here we will review how to initialize a shell environment and how to
execute directly a command.</p>
<div class="section level2">
<h2 id="initializing-a-shell-and-exiting-it">Initializing a shell and exiting it<a class="anchor" aria-label="anchor" href="#initializing-a-shell-and-exiting-it"></a>
</h2>
<p>The <code>shell</code> command initializes a new interactive shell
inside the container.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell centos7-devel_latest.sif</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Apptainer&gt;</code></pre>
</div>
<p>In this case, the container works as a lightweight virtual machine in
which you can execute commands. Remember, inside the container you have
the same user and permissions.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> id</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>uid=1001(myuser) gid=1001(myuser) groups=1001(myuser),500(myothergroup)</code></pre>
</div>
<p>Now quit the container by typing</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> exit</span></code></pre>
</div>
<p>or hitting <code>Ctrl + D</code>. Note that when exiting from the
Apptainer image all the running processes are killed (stopped). Changes
saved into bound directories are preserved. By default anything else in
the container is lost (we’ll see later about writable images).</p>
</div>
<div class="section level2">
<h2 id="bound-directories">Bound directories<a class="anchor" aria-label="anchor" href="#bound-directories"></a>
</h2>
<p>When an outside directory is accessible also inside Apptainer we say
it is <em>bound</em>, or bind mounted. The path to access it may differ
but anything you do to its content outside is visible inside and
vice-versa. By default, Apptainer binds the home of the user,
<code>/tmp</code> and <code>$PWD</code> into the container. This means
your files at <code>hostname:~/</code> are accessible inside the
container. You can specify additional bind mounts using the
<code>--bind</code> option. For example, let’s say <code>/cvmfs</code>
is available in the host, and you would like to have access to CVMFS
inside the container (here, <em>host</em> refers to the computer/server
that you are running apptainer on). Then let’s do</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell <span class="at">--bind</span> /cvmfs:/mnt centos7-devel_latest.sif</span></code></pre>
</div>
<p>Here, the colon <code>:</code> separates the path to the directory on
the host (<code>/cvmfs/</code>) from the mounting point
(<code>/mnt/</code>) inside of the container. If you do not have CVMFS,
you can try the command with <a href="https://stackoverflow.com/a/12649407/" class="external-link"><code>/opt</code></a>, for
example. More information on binding is provided <a href="%7B%7B%20site.baseurl%20%7D%7D/07-file-sharing">later</a>.</p>
<p>Let’s check that this works:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Apptainer&gt; ls /mnt/cms.cern.ch
bin                        etc                  SITECONF           slc7_aarch64_gcc530
bootstrap.sh               external             slc5_amd64_gcc434  slc7_aarch64_gcc700
...</code></pre>
</div>
<div id="urls-as-input" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="urls-as-input" class="callout-inner">
<h3 class="callout-title">URLs as input<a class="anchor" aria-label="anchor" href="#urls-as-input"></a>
</h3>
<div class="callout-content">
<p>Each of the different commands to set a container from a local
<code>.sif</code> also accepts the URL of the image as input. For
example, starting a shell with Scientific Linux 6 is as easy as</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell docker://sl:6</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>2020/12/17 21:42:46  info unpack layer: sha256:e0a6b33502f39d76f7c70213fa5b91688a46c2217ad9ba7a4d1690d33c6675ef
INFO:    Creating SIF file...
Apptainer&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="executing-commands">Executing commands<a class="anchor" aria-label="anchor" href="#executing-commands"></a>
</h2>
<p>The command <code>exec</code> starts the container from a specified
image and executes a command inside it. Let’s use the official <a href="https://hub.docker.com/r/rootproject/root" class="external-link">Docker image of
ROOT</a> to start ROOT inside a container:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> exec docker://rootproject/root root <span class="at">-b</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO:    Converting OCI blobs to SIF format
INFO:    Starting build...

   ------------------------------------------------------------------
  | Welcome to ROOT 6.22/06                        https://root.cern |
  | (c) 1995-2020, The ROOT Team; conception: R. Brun, F. Rademakers |
  | Built for linuxx8664gcc on Nov 27 2020, 15:14:08                 |
  | From tags/v6-22-06@v6-22-06                                      |
  | Try '.help', '.demo', '.license', '.credits', '.quit'/'.q'       |
   ------------------------------------------------------------------

/bin/bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
root [0]
</code></pre>
</div>
<p>And just like that, ROOT can be used in any laptop, large-scale
cluster or grid system with Apptainer available.</p>
<div id="execute-python-with-pyroot-available" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="execute-python-with-pyroot-available" class="callout-inner">
<h3 class="callout-title">Execute Python with PyROOT available<a class="anchor" aria-label="anchor" href="#execute-python-with-pyroot-available"></a>
</h3>
<div class="callout-content">
<p>Using the official Docker image of ROOT, start a Python session with
PyROOT available.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> exec docker://rootproject/root python3</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO:    Using cached SIF image
Python 3.8.5 (default, Jul 28 2020, 12:59:40)
[GCC 9.3.0] on linux
&gt;&gt;&gt; import ROOT
&gt;&gt;&gt; # Now you can work with PyROOT, creating a histogram for example
&gt;&gt;&gt; h = ROOT.TH1F("myHistogram", "myTitle", 50, -10, 10)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Use <code>singularity --version</code> to know what you are using
and to communicate it if asking for support</li>
<li>“A container can be started from a local <code>.sif</code> or
directly with the URL of the image.”</li>
<li>“Apptainer is also compatible with Docker images, providing access
to the large collection of images hosted by Docker Hub.”</li>
<li>Get a shell inside of your container with
<code>apptainer shell &lt;path/URL to image&gt;</code>
</li>
<li>Execute a command inside of your container with
<code>apptainer exec &lt;path/URL&gt; &lt;command&gt;</code>
</li>
<li>Bind outside directories with <code>--bind</code>
</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</div></section><section id="aio-03-break"><p>Content from <a href="03-break.html">Coffee break!</a></p>
<hr>
<p> Last updated on 2023-08-14 | 
        
        <a href="https://github.com/mambelli/hsf-training-apptainer/edit/main/episodes/03-break.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“Get up, stretch out, and dance!”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Refresh your mind!”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/0E00Zuayv9Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
</center></section><section id="aio-04-building-containers"><p>Content from <a href="04-building-containers.html">Building Containers</a></p>
<hr>
<p> Last updated on 2023-08-14 | 
        
        <a href="https://github.com/mambelli/hsf-training-apptainer/edit/main/episodes/04-building-containers.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How to build containers with my requirements?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Download and assemble containers from available images in the
repositories.”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<iframe width="427" height="251" src="https://www.youtube.com/embed/aqjxxc2kMlU?list=PLKZ9c4ONm-VkxWW98Gcn9H6WwykMiqtnF" title="Intro to Apptainer/Singularity #3 - Building Containers" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe><p>Running containers from the available public images is not the only
option. In many cases, it is required to modify an image or even to
create a new one from scratch. For such purposes, Apptainer provides the
command <code>build</code>, defined in the documentation as the
<em>Swiss army knife</em> of container creation.</p>
<p>The usual workflow is to prepare and test a container in a build
environment (like your laptop), either with an interactive session or
from a definition file, and then to deploy the container into a
production environment for execution (as your institutional cluster).
Interactive sessions are great to experiment and test your new
container. If you want to distribute the container or use it in
production, then we recommend to build it from a definition file, as
described in the next episode. This ensures the greatest possibility of
reproducibility and transparency.</p>
<figure><img src="https://journals.plos.org/plosone/article/figure/image?size=large&amp;id=10.1371/journal.pone.0177459.g001" alt="Apptainer/Singularity usage workflow" class="figure"><figcaption>
‘Apptainer/Singularity usage workflow’ via <i>Kurtzer GM, Sochat V,
Bauer MW (2017) Singularity: Scientific containers for mobility of
compute. PLoS ONE 12(5): e0177459.
<a href="https://doi.org/10.1371/journal.pone.0177459" class="external-link">https://doi.org/10.1371/journal.pone.0177459</a></i>
</figcaption></figure><section id="build-a-container-in-an-interactive-session"><h2 class="section-heading">Build a container in an interactive session<a class="anchor" aria-label="anchor" href="#build-a-container-in-an-interactive-session"></a>
</h2>
<hr class="half-width">
<p>While images contained in the <code>.sif</code> files are more
compact and immutable objects, ideal for reproducibility, for building
and testing images is more convenient the use of a <em>sandbox</em>,
which can be easily modified.</p>
<p>The command <code>build</code> provides a flag <code>--sandbox</code>
that will create a writable directory, <code>myCentOS7</code>, in your
work directory:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> build <span class="at">--sandbox</span> myCentOS7 docker://centos:centos7</span></code></pre>
</div>
<div id="notes-on-shared-file-systems-like-afs" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="notes-on-shared-file-systems-like-afs" class="callout-inner">
<h3 class="callout-title">Notes on shared file systems like AFS<a class="anchor" aria-label="anchor" href="#notes-on-shared-file-systems-like-afs"></a>
</h3>
<div class="callout-content">
<p>Avoid using the <a href="https://en.wikipedia.org/wiki/Andrew_File_System" class="external-link"><code>AFS</code>
(Andrew File System)</a> and possibly other shared file systems as
sandbox directory, as these systems can lead to permission issues. In
particular, this applies to your home directory on <a href="https://cern.service-now.com/service-portal?id=service_element&amp;name=lxplus-service" class="external-link"><code>lxplus</code></a>.
Instead, make sure to use the local file system by creating a folder in
<code>/tmp/</code>: <code>mkdir /tmp/$USER</code>. Then, replace
<code>myCentOS7</code> in the previous (and next) command with
<code>/tmp/$USER/myCentOS7</code>.</p>
</div>
</div>
</div>
<p>The container name is <code>myCentOS7</code>, and it has been
initialized from the <a href="https://hub.docker.com/_/centos" class="external-link">official
Docker image</a> of CentOS7. To initialize an interactive session use
the <code>shell</code> command. And to write files within the sandbox
directory use the <code>--writable</code> option. Finally, the
installation of new components will require superuser access inside the
container, so use also the <code>--fakeroot</code> option, unless you
are already root also outside.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell <span class="at">--writable</span> <span class="at">--fakeroot</span> myCentOS7</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> whoami</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">root</span></span></code></pre>
</div>
<p>Depending on the Apptainer/Singularity installation (privileged or
unprivileged) and the version, you may have some requirements, like the
<code>fakeroot</code> utility or <code>newuidmap</code> and
<code>newgidmap</code>. If you get an error when using
<code>--fakeroot</code> have a look at the <a href="https://apptainer.org/docs/user/main/fakeroot.html" class="external-link">fakeroot
documentation</a>. ::::::::::::::::::::::::::::::::::::::::: callout ##
<code>--fakeroot</code> is not root ATTENTION! <a href="https://apptainer.org/docs/user/main/fakeroot.html" class="external-link"><code>--fakeroot</code></a>
allows you to be root inside a container that you own but is not
changing who you are outside. All the outside actions and the writing on
bound files and directories will happen as your outside user, even if in
the container is done by root.
::::::::::::::::::::::::::::::::::::::::::::::::::</p>
<p>As an example, let’s create a container with Pythia8 available using
the <code>myCentOS7</code> sandbox. First, we need to install the
development tools (remember that in this interactive session we are
superuser):</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> yum groupinstall <span class="st">'Development Tools'</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> yum install python3-devel</span></code></pre>
</div>
<p>Where <code>yum</code> is the <a href="https://en.wikipedia.org/wiki/Yum_(software)" class="external-link">package manager used
in RHEL distributions</a> (like CentOS).</p>
<p>We will follow the installation steps described in the <a href="https://pythia.org/" class="external-link">Pythia website</a>. Here is a summary of the
commands you will need (you may need to adjust link and commands if
there is a new Pythia version):</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> mkdir /opt/pythia <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> /opt/pythia</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> curl <span class="at">-o</span> pythia8307.tgz https://pythia.org/download/pythia83/pythia8307.tgz</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> tar xvfz pythia8307.tgz</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> ln <span class="at">-s</span> pythia8307 pythia8</span></code></pre>
</div>
<p>To enable the Python interface, we add the flag
<code>--with-python-include</code> during the configuration, pointing to
the location of the Python headers:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> cd pythia8307</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> ./configure <span class="at">--with-python-include</span><span class="op">=</span>/usr/include/python3.6m/</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> make</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> exit</span></code></pre>
</div>
<p>Now, open an interactive session with your user (no
<code>--fakeroot</code>). You can use now the container with Pythia8
ready in a few steps. Let’s use the Python interface:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell myCentOS7</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> export PYTHONPATH=/opt/pythia/pythia8/lib:<span class="va">$PYTHONPATH</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> export LD_LIBRARY_PATH=/opt/pythia/pythia8/lib:<span class="va">$LD_LIBRARY_PATH</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> python3</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> import <span class="ex">pythia8</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> pythia <span class="ex">=</span> pythia8.Pythia<span class="er">(</span><span class="kw">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> *------------------------------------------------------------------------------------*
 |                                                                                    |
 |  *------------------------------------------------------------------------------*  |
 |  |                                                                              |  |
 |  |                                                                              |  |
 |  |   PPP   Y   Y  TTTTT  H   H  III    A      Welcome to the Lund Monte Carlo!  |  |
 |  |   P  P   Y Y     T    H   H   I    A A     This is PYTHIA version 8.307      |  |
 |  |   PPP     Y      T    HHHHH   I   AAAAA    Last date of change: 25 Feb 2022  |  |
 |  |   P       Y      T    H   H   I   A   A                                      |  |
 |  |   P       Y      T    H   H  III  A   A    Now is 03 Nov 2022 at 18:38:40    |  |

...
 |  |   Copyright (C) 2022 Torbjorn Sjostrand                                      |  |
 |  |                                                                              |  |
 |  *------------------------------------------------------------------------------*  |
 |                                                                                    |
 *------------------------------------------------------------------------------------*</code></pre>
</div>
<p>Notice that we need to define the environment variables
<code>PYTHONPATH</code> and <code>LD_LIBRARY_PATH</code> in order to use
Pythia on Python. We will automate this in the next section.</p>
<div id="execute-python-with-pyroot-available" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="execute-python-with-pyroot-available" class="callout-inner">
<h3 class="callout-title">Execute Python with PyROOT available<a class="anchor" aria-label="anchor" href="#execute-python-with-pyroot-available"></a>
</h3>
<div class="callout-content">
<p>Build a container to use uproot in Python 3.9.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>Start from the <a href="https://hub.docker.com/_/python" class="external-link">Python 3.9
Docker image</a> and create the <code>myPython</code> sandbox:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> build <span class="at">--sandbox</span> myPython docker://python:3.9</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell myPython</span></code></pre>
</div>
<p>Once inside the container, you can install <a href="https://uproot.readthedocs.io/en/latest/index.html" class="external-link">Uproot</a>.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> python3 <span class="at">-m</span> pip install <span class="at">--upgrade</span> pip</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> python3 <span class="at">-m</span> pip install uproot awkward</span></code></pre>
</div>
<p>Exit the container and use it as you like:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> exec myPython python <span class="at">-c</span> <span class="st">"import uproot; print(uproot.__doc__)"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Uproot: ROOT I/O in pure Python and NumPy.
...</code></pre>
</div>
<p>Notice how we did not need neither <code>--writable</code> nor
<code>--fakeroot</code> for the installation, but everything worked fine
since pip installs user packages in the user $HOME directory. In
addition, Apptainer/Singularity by default mounts the user home
directory as read+write, even if the container is read-only. This is why
a <em>sandbox</em> is great to test and experiment locally, but should
not be used for containers that will be shared or deployed. Manual
changes and local directories are difficult to reproduce and control.
Once you are happy with the content, you should use definition files,
described in the next episode.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“The command <code>build</code> is the basic tool for the creation
of containers.”</li>
<li>“A <em>sandbox</em> is a writable directory where containers can be
built interactively.”</li>
<li>“Superuser permissions are required to build containers if you need
to install packages or manipulate the operating system.”</li>
<li>“Use interactive builds only for development and tests, use
definition files for production or publicly distributed
containers.”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-05-definition-files"><p>Content from <a href="05-definition-files.html">Containers from definition files</a></p>
<hr>
<p> Last updated on 2023-08-14 | 
        
        <a href="https://github.com/mambelli/hsf-training-apptainer/edit/main/episodes/05-definition-files.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How to easily build and deploy containers from a single definition
file?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Create a container from a definition file.”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<iframe width="427" height="251" src="https://www.youtube.com/embed/v2ZJ0L3TF48?list=PLKZ9c4ONm-VkxWW98Gcn9H6WwykMiqtnF" title="Intro to Apptainer/Singularity #4 - Definition files" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe><p>As shown in the previous chapter, building containers with an
interactive session may take several steps, and it can become as
complicated as the setup is needed. An Apptainer definition file
provides an easy way to build and deploy containers.</p>
<section id="hello-world-apptainer"><h2 class="section-heading">Hello World Apptainer<a class="anchor" aria-label="anchor" href="#hello-world-apptainer"></a>
</h2>
<hr class="half-width">
<p>The following recipe shows how to build a hello-world container, and
run the container on your local computer.</p>
<ul>
<li>
<p>Step 1: Open a text editor (e.g., nano, vim, or gedit in a
graphical environment)</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nano</span> hello-world.def</span></code></pre>
</div>
</li>
<li>
<p>Step 2: Include the following script in the
<code>hello-world.def</code> file to define the environment</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">BootStrap:</span> docker</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">From:</span> ubuntu:20.04</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">%runscript</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">"Hello World"</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Print Hello world when the image is loaded</span></span></code></pre>
</div>
<p>In the above script, the first line - <code>BootStrap: docker</code>
indicates that apptainer will use the docker protocol to retrieve the
base OS to start the image. The <code>From: ubuntu:20.04</code> is given
to apptainer to start from a specific image/OS in Docker Hub. Any
content within the <code>%runscript</code> will be written to a file
that is executed when one runs the apptainer image. The
<code>echo "Hello World"</code> command will print the
<code>Hello World</code> on the terminal. Finally the <code>#</code>
hash is used to include comments within the definition file.</p>
</li>
<li>
<p>Step 3: Build the image</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> build hello-world.sif hello-world.def</span></code></pre>
</div>
<p>The <code>hello-world.sif</code> file specifies the name of the
output file that is built when using the <code>apptainer build</code>
command.</p>
</li>
<li>
<p>Step 4: Run the image</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./hello-world.sif</span></span></code></pre>
</div>
</li>
</ul>
<div class="section level3">
<h3 id="deleting-apptainer-image">Deleting Apptainer image<a class="anchor" aria-label="anchor" href="#deleting-apptainer-image"></a>
</h3>
<p>To delete the hello-world Apptainer image, simply delete the
<code>hello-world.sif</code> file.</p>
<div id="apptainer-delete" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="apptainer-delete" class="callout-inner">
<h3 class="callout-title">
<code>apptainer delete</code><a class="anchor" aria-label="anchor" href="#apptainer-delete"></a>
</h3>
<div class="callout-content">
<p>Note that there is also a <code>apptainer delete</code> command, but
it is to delete an image from a remote library. To learn more about
using remote endpoints and pulling and pushing images from or to
libraries, read <a href="https://apptainer.org/docs/user/main/endpoint.html" class="external-link">Remote
Endpoints</a> and <a href="https://apptainer.org/docs/user/main/library_api.html" class="external-link">Library API
Registries</a>.</p>
</div>
</div>
</div>
</div>
</section><section id="example-of-a-more-elaborated-definition-file"><h2 class="section-heading">Example of a more elaborated definition file<a class="anchor" aria-label="anchor" href="#example-of-a-more-elaborated-definition-file"></a>
</h2>
<hr class="half-width">
<p>Let’s look at the structure of the definition file with another
example. Let’s prepare a container from an <a href="https://hub.docker.com/_/ubuntu" class="external-link">official Ubuntu image</a>, but
this time we will install ROOT with RooFit and Python integration.</p>
<p>Following the ROOT instructions to <a href="https://root.cern/install/#download-a-pre-compiled-binary-distribution" class="external-link">download
a pre-compiled binary distribution</a>, the definition file will look
like</p>
<pre class="source"><code>BootStrap: docker
From: ubuntu:20.04

%post
    apt-get update -y
    apt-get install wget -y
    export DEBIAN_FRONTEND=noninteractive
    apt-get install dpkg-dev cmake g++ gcc binutils libx11-dev libxpm-dev \
        libxft-dev libxext-dev python libssl-dev libgsl0-dev libtiff-dev -y
    cd /opt
    wget https://root.cern/download/root_v6.22.06.Linux-ubuntu20-x86_64-gcc9.3.tar.gz
    tar -xzvf root_v6.22.06.Linux-ubuntu20-x86_64-gcc9.3.tar.gz

%environment
    export PATH=/opt/root/bin:$PATH
    export LD_LIBRARY_PATH=/opt/root/lib:$LD_LIBRARY_PATH
    export PYTHONPATH=/opt/root/lib

%runscript
    python /opt/root/tutorials/roofit/rf101_basics.py

%labels
    Author HEPTraining
    Version v0.0.1

%help
    Example container running the RooFit tutorial and producing the rf101_basics.png image.
    The container provides ROOT with RooFit and Python integration running on Ubuntu.</code></pre>
<p>Let’s take a look at the <a href="https://apptainer.org/docs/user/main/definition_files.html" class="external-link">definition
file</a>: * The first two lines define the base image. In this case, the
image <code>ubuntu:20.04</code> from Docker Hub is used. *
<code>%post</code> are lines to execute inside the container after the
OS has been set. In this example, we are listing the steps that we would
follow to install ROOT with a precompiled binary in an interactive
session. Notice that the binary used corresponds with the Ubuntu version
defined at the second line. * <code>%environment</code> is used to
define environment variables available inside the container. Here we are
setting the env variables required to execute ROOT and PyROOT. *
Apptainer containers can be executable. <code>%runscript</code> define
the actions to take when the container is executed. To illustrate the
functionality, we will just run <a href="https://root.cern/doc/master/rf101__basics_8py.html" class="external-link">rf101_basics.py</a>
from the RooFit tutorial. * <code>%labels</code> add custom metadata to
the container. * <code>%help</code> it is the container documentation:
what it is and how to use it. Can be displayed using
<code>apptainer run-help</code></p>
<p>Save this definition file as <code>rootInUbuntu.def</code>. To build
the container, just provide the definition file as argument (executing
as superuser):</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> build rootInUbuntu.sif rootInUbuntu.def</span></code></pre>
</div>
<p>Then, an interactive shell inside the container can be initialized
with <code>apptainer shell</code>, or a command executed with
<code>apptainer exec</code>. A third option is execute the actions
defined inside <code>%runscript</code> simply by calling the container
as an executable</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./rootInUbuntu.sif</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>RooFit v3.60 -- Developed by Wouter Verkerke and David Kirkby
                Copyright (C) 2000-2013 NIKHEF, University of California &amp; Stanford University
                All rights reserved, please read http://roofit.sourceforge.net/license.txt
...
 PARAMETER  CORRELATION COEFFICIENTS
       NO.  GLOBAL      1      2
        1  0.02723   1.000  0.027
        2  0.02723   0.027  1.000
[#1] INFO:Minization -- RooMinimizer::optimizeConst: deactivating const optimization
RooRealVar::mean = 1.01746 +/- 0.0300144  L(-10 - 10)
RooRealVar::sigma = 2.9787 +/- 0.0219217  L(0.1 - 10)
Info in &lt;TCanvas::Print&gt;: png file rf101_basics.png has been created</code></pre>
</div>
<p>You will find the output file <code>rf101_basics.png</code> in the
location where the container was executed. If you don’t have a DISPLAY
setup, Root may complain. Ignore the error messages, the image will be
created anyway,</p>
<p>Here we have covered the basics with a few examples focused to HEP
software. Check the <a href="https://apptainer.org/docs/user/main/build_a_container.html" class="external-link">Apptainer
docs</a> to see all the available options and more details related to
the container creation.</p>
<p>A few <a href="https://apptainer.org/docs/user/1.0/definition_files.html#best-practices-for-build-recipes" class="external-link">best
practices for your containers</a> to make them more usable, portable,
and secure: 1. Always install packages, programs, data, and files into
operating system locations (e.g. not <code>/home</code>,
<code>/tmp</code> , or any other directories that might get commonly
binded on). 1. Document your container. If your runscript doesn’t supply
help, write a <code>%help</code> or <code>%apphelp</code> section. A
good container tells the user how to interact with it. 1. If you require
any special environment variables to be defined, add them to the
<code>%environment</code> and <code>%appenv</code> sections of the build
recipe. 1. Files should always be owned by a system account (UID less
than 500). 1. Ensure that sensitive files like <code>/etc/passwd</code>,
<code>/etc/group</code>, and <code>/etc/shadow</code> do not contain
secrets. 1. Build production containers from a definition file instead
of a sandbox that has been manually changed. This ensures the greatest
possibility of reproducibility and mitigates the “black box” effect.</p>
<div id="deploying-your-containers" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="deploying-your-containers" class="callout-inner">
<h3 class="callout-title">Deploying your containers<a class="anchor" aria-label="anchor" href="#deploying-your-containers"></a>
</h3>
<div class="callout-content">
<p>Keep in mind that, while building a container may be time consuming,
the execution can be immediate and anywhere your image is available.
Once your container is built with the requirements of your analysis, you
can deploy it in a large cluster and execute it as far as Apptainer is
available on the site.</p>
<p>Libraries like <a href="https://cloud.sylabs.io/library" class="external-link">Sylabs Cloud
Library</a> ease the distribution of images. Organizations like OSG
provide instructions to <a href="https://portal.osg-htc.org/documentation/htc_workloads/using_software/containers/" class="external-link">use
available images</a> and <a href="https://portal.osg-htc.org/documentation/htc_workloads/using_software/containers-docker/" class="external-link">distribute
custom images via CVMFS</a>.</p>
<p>Be smart, and this will open endless possibilities in your
workflow.</p>
</div>
</div>
</div>
<div id="write-a-definition-file-to-build-a-container-with-pythia8-available-in-python" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="write-a-definition-file-to-build-a-container-with-pythia8-available-in-python" class="callout-inner">
<h3 class="callout-title">Write a definition file to build a container
with Pythia8 available in Python<a class="anchor" aria-label="anchor" href="#write-a-definition-file-to-build-a-container-with-pythia8-available-in-python"></a>
</h3>
<div class="callout-content">
<p>Following the example of the first section in which a container is
built with an interactive session, write a definition file to deploy a
container with Pythia8 available.</p>
<p>Take a look at <a href="https://gitlab.com/Pythia8/releases/-/blob/pythia8307/examples/main01.py" class="external-link"><code>/opt/pythia/pythia8307/examples/main01.py</code></a>
and define the <code>%runscript</code> to execute it using
<code>python3</code>.</p>
<p>(Tip: notice that main01.py requires <code>Makefile.inc</code>).</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<pre class="source"><code>BootStrap: docker
From: centos:centos7
 
%post
    yum -y groupinstall 'Development Tools'
    yum -y install python3-devel
    mkdir /opt/pythia &amp;&amp; cd /opt/pythia
    curl -o pythia8307.tgz https://pythia.org/download/pythia83/pythia8307.tgz
    tar xvfz pythia8307.tgz
    cd pythia8307
    ./configure --with-python-include=/usr/include/python3.6m/
    make

%environment
    export PYTHONPATH=/opt/pythia/pythia8307/lib:$PYTHONPATH
    export LD_LIBRARY_PATH=/opt/pythia/pythia8307/lib:$LD_LIBRARY_PATH
 
%runscript
    cp /opt/pythia/pythia8307/Makefile.inc .
    python3 /opt/pythia/pythia8307/examples/main01.py
 
%labels
    Author HEPTraining
    Version v0.0.1
 
%help
    Container providing Pythia 8.307. Execute the container to run an example.
    Open it in a shell to use the Pythia installation with Python 3.6</code></pre>
<p>Build your container executing</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> build pythiaInCentos7.sif myPythia8.def</span></code></pre>
</div>
<p>And finally, execute the container to run <a href="https://gitlab.com/Pythia8/releases/-/blob/pythia8307/examples/main01.py" class="external-link"><code>main01.py</code></a></p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./pythiaInCentos7.sif</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“An Apptainer definition file provides an easy way to build and
deploy containers.”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-06-break"><p>Content from <a href="06-break.html">Coffee break!</a></p>
<hr>
<p> Last updated on 2023-08-14 | 
        
        <a href="https://github.com/mambelli/hsf-training-apptainer/edit/main/episodes/06-break.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“Get up, stretch out, and dance!”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Refresh your mind!”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/VB5tYHeEYJI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
</center></section><section id="aio-07-file-sharing"><p>Content from <a href="07-file-sharing.html">Sharing files between host and container</a></p>
<hr>
<p> Last updated on 2023-08-14 | 
        
        <a href="https://github.com/mambelli/hsf-training-apptainer/edit/main/episodes/07-file-sharing.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How to read and write files on the host system from within the
container?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Map directories on your host system to directories within your
container.”</li>
<li>“Learn about the bind paths included automatically in all
containers.”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<iframe width="427" height="251" src="https://www.youtube.com/embed/E-vlXHEsacE?list=PLKZ9c4ONm-VkxWW98Gcn9H6WwykMiqtnF" title="Intro to Apptainer/Singularity #5 - Sharing files between host and container" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe><p>One of the key features about containers is the isolation of the
processes running inside them. It means, files on the host system are
not accessible within the container. However, it is very common that
some files on the host system are needed inside the container, or you
want to write files from the container to some directory in the
host.</p>
<p>We have already used the option <code>--bind</code> earlier in the
module when exploring the options available to run Apptainer containers.
In this chapter we will explore further options to bind directories from
your host system to directories within your container.</p>
<p>Remember that in Apptainer, your user outside is the same inside the
container (except when using fakeroot). And the same happens with
permissions and ownership for files in bind directories.</p>
<section id="bind-paths-included-by-default"><h2 class="section-heading">Bind paths included by default<a class="anchor" aria-label="anchor" href="#bind-paths-included-by-default"></a>
</h2>
<hr class="half-width">
<p>For each container executed, Apptainer binds automatically some
directories by default, and other defined by the system admin in the
Apptainer configuration. By default, Apptainer binds: * The user’s home
directory (<span class="math inline">\(HOME) * The current directory
when the container is executed (\)</span>PWD) * System-defined paths:
<code>/tmp</code>, <code>/proc</code>, <code>/dev</code>, etc. Since
this is defined in the configuration, it may vary from site to site.</p>
<p>Let’s use for example the container built during the last chapter
called <code>rootInUbuntu.sif</code>. Take a look at your current
directory</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">pwd</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/home/myuser/somedirectory</code></pre>
</div>
<p>Open a shell inside the container and try to use <code>pwd</code>
again</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell rootInUbuntu.sif</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Apptainer</span><span class="op">&gt;</span> pwd</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/home/myuser/somedirectory</code></pre>
</div>
<p>you will notice that the files stored on the host are located inside
the container! As we explained above, Apptainer mounts automatically
your <code>$HOME</code> inside the container.</p>
<div id="disabling-system-binds" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="disabling-system-binds" class="callout-inner">
<h3 class="callout-title">Disabling system binds<a class="anchor" aria-label="anchor" href="#disabling-system-binds"></a>
</h3>
<div class="callout-content">
<p>If for any reason you want to execute a container removing the
default binds, the command-line option <code>--no-mount</code> is
available. For example, to disable the bind of <code>/tmp</code></p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">run</span> <span class="at">--no-mount</span> tmp my_container.sif</span></code></pre>
</div>
</div>
</div>
</div>
<p>Try this time with</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell <span class="at">--no-mount</span> home rootInUbuntu.sif</span></code></pre>
</div>
<p>and you will notice that <code>$HOME</code> is not mounted
anymore</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> /home/myuser</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>ls: cannot access '/home/myuser': No such file or directory</code></pre>
</div>
</section><section id="user-defined-bind-paths"><h2 class="section-heading">User-defined bind paths<a class="anchor" aria-label="anchor" href="#user-defined-bind-paths"></a>
</h2>
<hr class="half-width">
<p>Apptainer provides mechanisms to specify additional binds when
executing a container via command-line or environment variables.
Apptainer offers a complex set of mechanism for binds or other mounts.
Here we present the main points, refer to the <a href="https://apptainer.org/docs/user/main/bind_paths_and_mounts.html" class="external-link">Bind
Paths and Mounts documentation</a> for more.</p>
<div class="section level3">
<h3 id="bind-with-command-line-options">Bind with command-line options<a class="anchor" aria-label="anchor" href="#bind-with-command-line-options"></a>
</h3>
<p>The command-line option <code>--bind (-B)</code> will specify the
directories that must be linked between the host and the container. It
is available for <code>run</code>, <code>exec</code> and
<code>shell</code> (as well for <code>instance</code> that is not
covered yet).</p>
<p>The syntax for using the bind option is
<code>"source:destination"</code>, and the paths must be absolute
(relative paths will be rejected). For example, let’s create a directory
in the host containing a constant that can be useful for your
analysis</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="va">$HOME</span>/mydata</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"MUONMASS=105.66 MeV"</span> <span class="op">&gt;</span> <span class="va">$HOME</span>/mydata/muonMass.txt</span></code></pre>
</div>
<p>It is very, very important in your analysis workflow to know the mass
of the muon, right? It may have sense to put the data in a high-level
directory within the container, like <code>/data</code></p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell <span class="at">--bind</span> <span class="va">$HOME</span>/mydata:/data rootInUbuntu.sif</span></code></pre>
</div>
<p>This will bind the directory <code>mydata/</code> from the host as
<code>/data</code> inside the container:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-l</span> /data</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>-rw-rw-r-- 1 myuser myuser 20 Jan  2 12:46 muonMass.txt</code></pre>
</div>
<p>Now you can use the mass of the muon from a root-level directory!</p>
<p>If multiple directories must be available in the container, you can
repeat the option or they can be defined with a comma between each pair
of directories, i.e. using the syntax
<code>source1:destination1,source2:destination2</code>.</p>
<p>Also. If the destination is not specified, it will be set as equal as
the source. For example</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell <span class="at">--bind</span> /cvmfs rootInUbuntu.sif</span></code></pre>
</div>
<p>Will mount <code>/cvmfs</code> inside the container. Try it!</p>
<div id="binding-directories-with-docker-like-syntax-using---mount" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="binding-directories-with-docker-like-syntax-using---mount" class="callout-inner">
<h3 class="callout-title">Binding directories with Docker-like syntax
using <code>--mount</code><a class="anchor" aria-label="anchor" href="#binding-directories-with-docker-like-syntax-using---mount"></a>
</h3>
<div class="callout-content">
<p>The flag –mount provides a method to bind directories using the
syntax of Docker. The bind is specified with the format
<code>type=bind,src=&lt;source&gt;,dst=&lt;dest&gt;</code>. Currently,
only <code>type=bind</code> is supported. Check the <a href="https://apptainer.org/docs/user/main/bind_paths_and_mounts.html#mount-examples" class="external-link">documentation</a>
for additional options available.</p>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="bind-with-environment-variables">Bind with environment variables<a class="anchor" aria-label="anchor" href="#bind-with-environment-variables"></a>
</h3>
<p>If the environment variable <code>$APPTAINER_BIND</code> is defined,
apptainer will bind inside ANY container the directories specified in
the format <code>source</code>, with the destination being optional (in
the same way as using <code>--bind</code>). For example:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">SINGULARITY_BIND</span><span class="op">=</span><span class="st">"/cvmfs"</span></span></code></pre>
</div>
<p>will bind CVMFS to all your Apptainer containers (<code>/cvmfs</code>
must be available in the host, of course).</p>
<p>You can also bind multiple directories using commas between each
<code>source:destination</code>.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“Bind mounts allow reading and writing files within the
container.”</li>
<li>“In Apptainer, you have same owner and permissions for files inside
and outside the container.”</li>
<li>“Some paths are mounted by default by Apptainer.”</li>
<li>“Additional directories to bind can be defined using the
<code>--bind</code> option or the environment variable
<code>$SINGULARITY_BIND</code>.”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</section></section><section id="aio-08-instances"><p>Content from <a href="08-instances.html">Apptainer/Singularity instances</a></p>
<hr>
<p> Last updated on 2023-08-14 | 
        
        <a href="https://github.com/mambelli/hsf-training-apptainer/edit/main/episodes/08-instances.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How can I keep my container running in the background?”</li>
<li>“What are the use cases for instances?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Run containers in a detached mode to keep services up.”</li>
<li>“Deploy instances via definition files.”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<iframe width="427" height="251" src="https://www.youtube.com/embed/10s8yUScYM8" title="Intro to Apptainer/Singularity #6 - Instances" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe><p>As we have studied in previous chapters, commands such as
<code>run</code> and <code>shell</code> allocate Apptainer/Singularity
containers in the foreground, stopping any process running inside the
container after logout. This behavior suits the use case of containers
for executing interactive commands in a well-defined environment, but
there are cases when running processes in the background is convenient.
For example, when a web application like a Jupyter notebook is deployed
inside a container, it is desired to keep the container up while it
waits for connections from the web browser.</p>
<p>Apptainer provides the concept of <em>instances</em> to deploy
services in the background. While Docker is a common choice of tool for
setting services, Apptainer has the advantage of working without
requiring any special permissions (like when you are working in a
cluster provided by your university/laboratory). In this chapter we will
learn the basics about their capabilities and some use cases as
examples.</p>
<section id="instances-from-image-files"><h2 class="section-heading">Instances from image files<a class="anchor" aria-label="anchor" href="#instances-from-image-files"></a>
</h2>
<hr class="half-width">
<p>To start an instance, Apptainer provides the command
<code>instance</code>. To exemplify, let’s pull the CentOS image used in
previous chapters</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> pull docker://centos:centos7</span></code></pre>
</div>
<p>The image must be started in the following way:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> instance start centos_centos7.sif mycentos7</span></code></pre>
</div>
<p>In this example, the <code>.sif</code> is the image downloaded from
Dockerhub, and <code>mycentos7</code> is the name that we have assigned
to the instance. Instead of opening a shell session or executing a
command, the container is running in the background.</p>
<p>Confirm that the instance is running using the
<code>instance list</code> command</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> instance list</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INSTANCE NAME    PID      IP    IMAGE
mycentos7        10782          /home/myuser/centos_centos7.sif</code></pre>
</div>
<p>To interact with the instance, the commands <code>exec</code> and
<code>shell</code> are available. The instance must be referred as
<code>instance://name</code>. For example, to open a shell inside the
CentOS instance:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell instance://mycentos7</span></code></pre>
</div>
<p>Remember that exiting the shell instance will not stop the container.
For doing so, use <code>instance stop</code>:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> instance stop mycentos7</span></code></pre>
</div>
<p>You can confirm the instance doesn’t exist with
<code>instance list</code>.</p>
<div id="instances-with-bind-paths" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="instances-with-bind-paths" class="callout-inner">
<h3 class="callout-title">Instances with bind paths<a class="anchor" aria-label="anchor" href="#instances-with-bind-paths"></a>
</h3>
<div class="callout-content">
<p>When starting an instance, the same options for bind directories
between the host and the container as running an interactive session are
available. For example, if you want a directory mounted inside the
instance, use the <code>--bind</code> option:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> instance start <span class="at">--bind</span> /home/user/mydata:/data centos_centos7.sif mycentos7</span></code></pre>
</div>
<p>binding the directory <code>mydata/</code> from the host as
<code>/data</code> inside the instance.</p>
</div>
</div>
</div>
</section><section id="a-web-server-as-an-instance"><h2 class="section-heading">A web server as an instance<a class="anchor" aria-label="anchor" href="#a-web-server-as-an-instance"></a>
</h2>
<hr class="half-width">
<p>One of the main purposes of the Apptainer instances is deploying
services with customized environments. Before moving to more complex use
cases, let’s start with a basic example: a web service showing a HTML
with a message.</p>
<p>Let’s write a basic <code>index.html</code> file as:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">HTML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode html" tabindex="0"><code class="sourceCode html"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;head&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;title&gt;</span>My awesome service<span class="kw">&lt;/title&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/head&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h1&gt;</span>Hello world!<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>If you see this page, my awesome service is up and running.<span class="kw">&lt;/p&gt;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre>
</div>
<p>If you are not familiar with HTML take a quick look at the <a href="https://www.w3schools.com/html/" class="external-link">HTML Tutorial</a>, but it is not
mandatory. What really matters is having a minimal webpage that our
server will show.</p>
<p>Now, let’s prepare a basic web server using <a href="https://docs.python.org/3.9/library/http.server.html" class="external-link">Python
http.server</a>. Create a definition file, saved as
<code>basicServer.def</code>, which contains:</p>
<pre class="source"><code>Bootstrap: docker
From: ubuntu:20.04

%post
    apt-get update -y
    apt-get install -y python3.9

%files
    index.html /tmp/index.html

%startscript
   cd /tmp
   python3.9 -m http.server 8850</code></pre>
<p>If you recall the chapter about <a href="05-definition-files.html">definition files</a>, this definition
file will pull the official Ubuntu image from Dockerhub, and will
install Python3.9. In addition, it copies <code>index.html</code> in
<code>/tmp</code> <strong>inside</strong> the container. When the
instance starts, commands specified on <code>%startscript</code> are
executed. On this example, <code>http.server</code> will be executed,
serving a page in the port 8850 (you can use any other port if 8850 is
busy with another service).</p>
<p>Let’s build an image from the definition. Remember that building
images requires either superuser permissions or using the flag
<code>--fakeroot</code> as</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> build <span class="at">--fakeroot</span> basicServer.sif basicServer.def</span></code></pre>
</div>
<p>Now, let’s start an instance named <code>myWebService</code> with the
image that we just built</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> instance start <span class="at">--no-mount</span> tmp basicServer.sif myWebService</span></code></pre>
</div>
<p>Reminder from the previous chapter: with <code>--no-mount tmp</code>
we are asking Apptainer to NOT bind <code>/tmp</code> from the host to
the instance (it is mounted by default), we use instead an isolated
<code>/tmp</code> inside the instance where index.html has been
copied.</p>
<p>You can confirm in the terminal that the web service is up using
<code>curl</code> as</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8850</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to my service!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Hello world!&lt;/h1&gt;
&lt;p&gt;If you see this page, my awesome service is up and running.&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
<p>If you are executing Apptainer locally, try to open <a href="http://localhost:8850" class="external-link uri">http://localhost:8850</a>.</p>
<div id="ssh-tunneling" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="ssh-tunneling" class="callout-inner">
<h3 class="callout-title">SSH tunneling<a class="anchor" aria-label="anchor" href="#ssh-tunneling"></a>
</h3>
<div class="callout-content">
<p>If you are deploying a service in a cluster of your institution (as
LXPLUS at CERN) it is likely that you need SSH tunneling for opening
pages served by your service with a web browser. A basic port forwarding
can be configured as:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-L</span> <span class="op">&lt;</span>port<span class="op">&gt;</span>:localhost:<span class="op">&lt;</span>port<span class="op">&gt;</span> myuser@<span class="op">&lt;</span>server<span class="op">&gt;</span></span></code></pre>
</div>
<p>where <port> is the one used by your service, and <server> is the
address of your institutional resources. For example, for connecting to
LXPLUS forwarding the port 8850:</server></port></p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-L</span> 8850:localhost:8850 myuser@lxplus.cern.ch</span></code></pre>
</div>
<p>Then you can open <a href="http://localhost:8850" class="external-link uri">http://localhost:8850</a> in your machine!</p>
<p>Port numbers less than 1024 are privileged ports and can be used only
by root. Please consult the allowed ports and rules with your
institution.</p>
</div>
</div>
</div>
<p>Remember to stop the instance once you are done.</p>
</section><section id="serving-a-jupyter-notebook-with-custom-environment"><h2 class="section-heading">Serving a Jupyter notebook with custom environment<a class="anchor" aria-label="anchor" href="#serving-a-jupyter-notebook-with-custom-environment"></a>
</h2>
<hr class="half-width">
<p>As an example of the capabilities of instances as services, let’s
extend our definition file to deploy a Jupyter notebook server with a
customized environment.</p>
<p>What if we provide a Jupyter notebook ready to use ROOT? If you
remember our example from the <a href="05-definition-files.html">definition files chapter</a>, at this
point it must be almost straightforward:</p>
<pre class="source"><code>Bootstrap: docker
From: ubuntu:20.04

%post
    apt-get update -y
    apt-get install -y python3
    apt-get install -y python3-pip
    pip install notebook

    apt-get install wget -y
    export DEBIAN_FRONTEND=noninteractive
    apt-get install dpkg-dev cmake g++ gcc binutils libx11-dev libxpm-dev \
    libxft-dev libxext-dev python libssl-dev libgsl0-dev libtiff-dev -y
    cd /opt
    wget https://root.cern/download/root_v6.22.06.Linux-ubuntu20-x86_64-gcc9.3.tar.gz
    tar -xzvf root_v6.22.06.Linux-ubuntu20-x86_64-gcc9.3.tar.gz

%environment
    export PATH=/opt/root/bin:$PATH
    export LD_LIBRARY_PATH=/opt/root/lib:$LD_LIBRARY_PATH
    export PYTHONPATH=/opt/root/lib

%startscript
   jupyter notebook --port 8850</code></pre>
<p>Save the definition file as <code>jupyterWithROOT.def</code>, and
let’s build an image called <code>jupyterWithROOT.sif</code></p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> build <span class="at">--fakeroot</span> jupyterWithROOT.sif jupyterWithROOT.def</span></code></pre>
</div>
<p>Now, start an instance named <code>mynotebook</code> with our
brand-new image</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> instance start jupyterWithROOT.sif mynotebook</span></code></pre>
</div>
<p>and confirm that the instance is up</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> instance list</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INSTANCE NAME    PID      IP    IMAGE
mynotebook       10720          /home/myuser/jupyterWithROOT.sif</code></pre>
</div>
<p>If you go to <a href="http://localhost:8850" class="external-link uri">http://localhost:8850</a> (with SSH tunneling if needed),
you will find out that for security reasons the Jupyter webapp will ask
for an access token. Fortunately, you can get the token listing the URL
of active servers using the <code>jupyter notebook list</code> command.
To execute the command inside the instance, use
<code>sigularity exec</code>:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> exec instance://notebook jupyter notebook list</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Currently running servers:
http://localhost:8850/?token=12asldc9b2084f9b664b39a6246022312bc9c605b :: /home/myHome</code></pre>
</div>
<p>Open the URL with the token, and you will be able to see the Jupyter
interface. Try to open a new notebook and write in a cell to confirm
that ROOT is available:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ROOT</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Now you can work with PyROOT, creating a histogram for example</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> ROOT.TH1F(<span class="st">"myHistogram"</span>, <span class="st">"myTitle"</span>, <span class="dv">50</span>, <span class="op">-</span><span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>h.FillRandom(<span class="st">"gaus"</span>, <span class="dv">10000</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> ROOT.TCanvas(<span class="st">"myCanvasName"</span>,<span class="st">"The Canvas Title"</span>,<span class="dv">800</span>,<span class="dv">600</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>h.Draw()</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>c.Draw()</span></code></pre>
</div>
<p>The bottom line: with any Jupyter notebook that you write, you can
provide an Apptainer image that will set the environment required to
execute the cells. It doesn’t matter if yourself or someone else comes
in one, five, ten years, your code will work independently of the
software available in your computer as far as Apptainer/Singularity is
available!</p>
<div id="a-jupyter-notebook-with-uproot-available" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="a-jupyter-notebook-with-uproot-available" class="callout-inner">
<h3 class="callout-title">A Jupyter notebook with Uproot available<a class="anchor" aria-label="anchor" href="#a-jupyter-notebook-with-uproot-available"></a>
</h3>
<div class="callout-content">
<p>Can you setup a Jupyter notebook server with <a href="https://uproot.readthedocs.io/en/latest/index.html" class="external-link">Uproot</a>
available in Apptainer?</p>
<p>Hint: Uproot can be installed using <code>pip</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>## Solution</p>
<pre class="source"><code>Bootstrap: docker
From: ubuntu:20.04

%post
    apt-get update -y
    apt-get install -y python3
    apt-get install -y python3-pip
    pip install notebook
    pip install uproot

%startscript
   jupyter notebook --port 8850</code></pre>
<p>Confirm that Uproot is available opening a notebook and executing in
a cell</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> uproot</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(uproot.__doc__)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Instances allow to setup services via Apptainer images or definition
files.</li>
<li>Code provided in Jupyter notebooks can be accompanied by a
Apptainer/Singularity image with the environment needed for its
execution, ensuring the reproducibility of the results.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-09-bonus-episode"><p>Content from <a href="09-bonus-episode.html">Bonus Episode: Building and deploying an Apptainer container to Github Packages</a></p>
<hr>
<p> Last updated on 2023-08-14 | 
        
        <a href="https://github.com/mambelli/hsf-training-apptainer/edit/main/episodes/09-bonus-episode.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How to build apptainer container for python packages?</li>
<li>How to share apptainer images?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>To be able to build an apptainer container and share it via GitHub
packages</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="prerequisites" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="prerequisites" class="callout-inner">
<h3 class="callout-title">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h3>
<div class="callout-content">
<p>For this lesson, you will need, * Knowledge of Git <a href="https://swcarpentry.github.io/git-novice/" class="external-link">SW Carpentry Git-Novice
Lesson</a> * Knowledge of GitHub CI/CD <a href="https://hsf-training.github.io/hsf-training-cicd-github/" class="external-link">HSF
Github CI/CD Lesson</a></p>
</div>
</div>
</div>
<iframe width="427" height="251" src="https://www.youtube.com/embed/BRRaSsrK7-k" title="Intro to Apptainer/Singularity #7 - Bonus episode" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe><section id="apptainer-container-for-python-packages"><h2 class="section-heading">Apptainer Container for python packages<a class="anchor" aria-label="anchor" href="#apptainer-container-for-python-packages"></a>
</h2>
<hr class="half-width">
<p>Python packages can be installed using an Apptainer image. The
following example illustrates how to write a definition file for
building an image containing python packages.</p>
<pre class="text"><code>BootStrap: docker
From: ubuntu:20.04

%post
    apt-get update -y
    apt-get install wget -y
    export DEBIAN_FRONTEND=noninteractive
    apt-get install dpkg-dev cmake g++ gcc binutils libx11-dev libxpm-dev \
    libxft-dev libxext-dev python3 libssl-dev libgsl0-dev libtiff-dev \
    python3-pip -y
    pip3 install numpy
    pip3 install awkward
    pip3 install uproot4
    pip3 install particle
    pip3 install hepunits
    pip3 install matplotlib
    pip3 install hist
    pip3 install mplhep
    pip3 install vector
    pip3 install fastjet
    pip3 install iminuit</code></pre>
<p>As we see, several packages are installed.</p>
</section><section id="publish-apptainer-images-with-github-packages-and-share-them"><h2 class="section-heading">Publish Apptainer images with GitHub Packages and share them!<a class="anchor" aria-label="anchor" href="#publish-apptainer-images-with-github-packages-and-share-them"></a>
</h2>
<hr class="half-width">
<p>It is possible to publish apptainer images with <a href="https://github.com/features/packages" class="external-link">GitHub packages</a>. To do
so, one needs to use GitHub CI/CD. A step-by-step guide is presented
here.</p>
<ul>
<li>
<strong>Step 1</strong>: Create a GitHub repository and clone it
locally.</li>
<li>
<strong>Step 2</strong>: In the empty repository, make a folder
called <code>.github/workflows</code>. In this folder we will store the
file containing the YAML script for a GitHub workflow, named
<code>apptainer-build-deploy.yml</code> (the name doesn’t really
matter).</li>
<li>
<strong>Step 3</strong>: In the top directory of your GitHub
repository, create a file named <code>Apptainer</code>.</li>
<li>
<strong>Step 4</strong>: Copy-paste the content above and add to the
Apptainer file. (In principle it is possible to build this image
locally, but we will not do that here, as we wish to build it with
GitHub CI/CD).</li>
<li>
<strong>Step 5</strong>: In the
<code>apptainer-build-deploy.yml</code> file, add the following
content:</li>
</ul>
<pre class="text"><code>name: Apptainer Build Deploy

on:
  pull_request:
  push:
    branches: master

jobs:
  build-test-container:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    container:
        image: quay.io/singularity/singularity:v3.8.1
        options: --privileged

    name: Build Container
    steps:

      - name: Check out code for the container builds
        uses: actions/checkout@v2

      - name: Build Container
        run: |
           singularity build container.sif Apptainer

      - name: Login and Deploy Container
        run: |
           echo ${{ secrets.GITHUB_TOKEN }} | singularity remote login -u ${{ secrets.GHCR_USERNAME }} --password-stdin oras://ghcr.io
           singularity push container.sif oras://ghcr.io/${GITHUB_REPOSITORY}:${tag}</code></pre>
<p>The above script is designed to build and publish a Apptainer image
with <a href="https://github.com/features/packages" class="external-link">GitHub
packages</a>.</p>
<ul>
<li>
<strong>Step 6</strong>: Add LICENSE and README as recommended in
the <a href="https://swcarpentry.github.io/git-novice/" class="external-link">SW Carpentry
Git-Novice Lesson</a>, and then the repository is good to go.</li>
</ul>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li> Python packages can be installed in apptainer images along with
ubuntu packages.</li>
<li> It is possible to publish and share apptainer images over github
packages.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
				<p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/mambelli/hsf-training-apptainer/edit/main/README.md" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/mambelli/hsf-training-apptainer/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a> 
        | <a href="https://github.com/mambelli/hsf-training-apptainer/" class="external-link">Source</a></p>
				<p><a href="https://github.com/mambelli/hsf-training-apptainer/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:hsf-training-wg@googlegroups.com">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">Template licensed under CC-BY 4.0</a> by <a href="https://carpentries.org" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper" class="external-link">sandpaper (0.12.5)</a>,
        <a href="https://github.com/carpentries/pegboard" class="external-link">pegboard (0.5.3)</a>,
      and <a href="https://github.com/carpentries/varnish/tree/0.2.17" class="external-link">varnish (0.2.17)</a>.</p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
			<i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back to top"></i><br><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://mambelli.github.io/hsf-training-apptainer/aio.html",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, lesson, The Carpentries, HSF, Apptainer, Singularity",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://mambelli.github.io/hsf-training-apptainer/aio.html",
  "identifier": "https://mambelli.github.io/hsf-training-apptainer/aio.html",
  "dateCreated": "2023-08-13",
  "dateModified": "2023-08-15",
  "datePublished": "2023-08-15"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code -->
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

